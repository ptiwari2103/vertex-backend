<%- contentFor('title') %>Card Management - Vertex Admin

    <%- contentFor('style') %>
        <style>
            .main-content {
                padding: 20px;
            }

            .filters-section {
                background: #fff;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }

            .table-section {
                background: #fff;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }

            .date-filter {
                max-width: 150px;
            }

            .status-badge {
                padding: 5px 10px;
                border-radius: 15px;
                font-size: 12px;
                font-weight: 500;
                cursor: pointer;
            }

            .status-active {
                background-color: #d4edda;
                color: #155724;
            }

            .status-pending {
                background-color: #fff3cd;
                color: #856404;
            }

            .status-inactive {
                background-color: #f8d7da;
                color: #721c24;
            }

            .action-btn {
                padding: 5px 10px;
                font-size: 14px;
                margin: 0 2px;
            }
        </style>

        <%- contentFor('body') %>
            <div class="main-content">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">List Cards</h2>
                </div>

                <!-- Filters Section -->
                <div class="filters-section">
                    <form id="filterForm" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">User ID</label>
                            <input type="text" class="form-control" name="user_id" maxlength="8"
                                value="<%= query.user_id || '' %>" placeholder="Enter User ID">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status">
                                <option value="">All</option>
                                <option value="Approved" <%=query.status==='Approved' ? 'selected' : '' %>>Approved
                                </option>
                                <option value="Rejected" <%=query.status==='Rejected' ? 'selected' : '' %>>Rejected
                                </option>
                                <option value="Blocked" <%=query.status==='Blocked' ? 'selected' : '' %>>Blocked
                                </option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">Filter</button>
                                <button type="button" class="btn btn-secondary" onclick="resetFilters()">Reset</button>
                            </div>
                        </div>
                    </form>
                </div>

                <script>
                    let currentCardId = null;
                    function updateCardStatus(id, currentStatus) {
                        currentCardId = id;
                        const statusSelect = document.getElementById('cardStatusSelect');
                        statusSelect.value = currentStatus;
                        const modal = new bootstrap.Modal(document.getElementById('cardStatusUpdateModal'));
                        modal.show();
                    }

                    async function confirmCardStatusUpdate() {
                        const newStatus = document.getElementById('cardStatusSelect').value;

                        try {
                            const response = await fetch(`/cards/${currentCardId}/status`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ status: newStatus })
                            });

                            if (response.ok) {
                                const modal = bootstrap.Modal.getInstance(document.getElementById('cardStatusUpdateModal'));
                                modal.hide();
                                location.reload();
                            } else {
                                const data = await response.json();
                                alert(data.message || 'Failed to update status');
                            }
                        } catch (error) {
                            console.error('Error updating status:', error);
                            alert('Failed to update status');
                        }
                    }

                    function openAddCardModal(cardId) {
                        document.getElementById('addCardId').value = cardId;
                        const addCardModal = new bootstrap.Modal(document.getElementById('addCardModal'));
                        addCardModal.show();
                    }

                    function submitAddCardForm() {
                        const form = document.getElementById('addCardForm');
                        if (!form.checkValidity()) {
                            form.classList.add('was-validated');
                            return;
                        }

                        const formData = new FormData(form);
                        const data = Object.fromEntries(formData.entries());
                        console.log("data", data);
                        fetch('/cards/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(data),
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Failed to update card');
                                }
                                // window.location.reload();
                            })
                            .catch(error => {
                                alert('Error updating card: ' + error.message);
                            });
                    }


                    function openViewCardModal(name, userId, accountNumber, cardNumber, expiryMonth, expiryYear, cardLimit, assignedDate,createddate, status) {
                        document.getElementById('viewName').innerText = name;
                        document.getElementById('viewUserId').innerText = userId;
                        document.getElementById('viewAccountNumber').innerText = accountNumber;
                        document.getElementById('viewCreatedDate').innerText = createddate ? new Date(createddate).toLocaleDateString() : '-';
                        document.getElementById('viewStatus').innerText = status;
                        document.getElementById('viewCardNumber').innerText = cardNumber;
                        document.getElementById('viewExpiryDate').innerText = expiryMonth + '/' + expiryYear;
                        document.getElementById('viewCardLimit').innerText = cardLimit;
                        document.getElementById('viewAssignedDate').innerText = assignedDate ? new Date(assignedDate).toLocaleDateString() : '-';

                        const viewCardModal = new bootstrap.Modal(document.getElementById('viewCardModal'));
                        viewCardModal.show();
                    }

                    function resetFilters() {
                        const form = document.getElementById('filterForm');
                        form.reset();
                        // Clear all form fields
                        const inputs = form.querySelectorAll('input, select');
                        inputs.forEach(input => {
                            if (input.type === 'text' || input.type === 'number' || input.tagName === 'SELECT') {
                                input.value = '';
                            }
                        });
                        // Submit the form with cleared values
                        window.location.href = '/cards/allcards';
                    }
                </script>

                <!-- Table Section -->
                <div class="table-section">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>S.No.</th>
                                    <th>User</th>
                                    <th>Account Number</th>
                                    <th>Card Number</th>
                                    <th>Requested At</th>
                                    <th>Assigned At</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% cards.forEach((card, index)=> { %>
                                    <tr>
                                        <td>
                                            <%= (pagination.currentPage - 1) * 10 + index + 1 %>
                                        </td>
                                        <td>
                                            <%= card.user.name %> (<%= card.user.user_id %>)
                                        </td>

                                        <td>
                                            <%= card.user.account_number %>
                                        </td>

                                        <td>
                                            <%= card.card_number %>
                                        </td>
                                        <td>
                                            <%= new Date(card.created_at).toLocaleDateString() %>
                                        </td>
                                        <td>
                                            <%= card.assigned_date ? new Date(card.assigned_date).toLocaleDateString()
                                                : '-' %>
                                        </td>
                                        <td>
                                            <span
                                                class="status-badge <%= card.status.toLowerCase() === 'approved' ? 'status-active' : 
                                                card.status.toLowerCase() === 'pending' ? 'status-pending' : 'status-inactive' %>"
                                                onclick="updateCardStatus('<%= card.id %>', '<%= card.status %>')">
                                                <%= card.status %>
                                            </span>
                                        </td>

                                        <td>
                                            <button class="btn btn-primary"
                                                onclick="openViewCardModal('<%= card.user.name %>','<%= card.user.user_id %>','<%= card.user.account_number %>','<%= card.card_number %>','<%= card.expiry_month %>','<%= card.expiry_year %>','<%= card.card_limit %>','<%= card.assigned_date %>','<%= card.created_at %>','<%= card.status %>')">View</button>
                                        </td>
                                    </tr>
                                    <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <nav>
                    <ul class="pagination">
                        <li class="page-item <%= pagination.currentPage === 1 ? 'disabled' : '' %>">
                            <a class="page-link"
                                href="?page=<%= pagination.currentPage - 1 %>&user_id=<%= query.user_id || '' %>&created_date=<%= query.created_date || '' %>"
                                tabindex="-1">Previous</a>
                        </li>
                        <% for(let i=1; i <=pagination.totalPages; i++) { %>
                            <li class="page-item <%= pagination.currentPage === i ? 'active' : '' %>">
                                <a class="page-link"
                                    href="?page=<%= i %>&user_id=<%= query.user_id || '' %>&created_date=<%= query.created_date || '' %>">
                                    <%= i %>
                                </a>
                            </li>
                            <% } %>
                                <li
                                    class="page-item <%= pagination.currentPage === pagination.totalPages ? 'disabled' : '' %>">
                                    <a class="page-link"
                                        href="?page=<%= pagination.currentPage + 1 %>&user_id=<%= query.user_id || '' %>&created_date=<%= query.created_date || '' %>">Next</a>
                                </li>
                    </ul>
                </nav>
            </div>
            </div>



            <!-- Add Card Modal -->
            <div class="modal fade" id="addCardModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Card</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addCardForm" class="needs-validation" novalidate>
                                <input type="hidden" name="card_id" id="addCardId">
                                <div class="mb-3">
                                    <label class="form-label">Expiry Date</label>
                                    <input type="month" class="form-control" name="expiry_date" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Card Limit</label>
                                    <input type="number" step="0.01" class="form-control" name="card_limit" required>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="submitAddCardForm()">Save
                                changes</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View Card Modal -->
            <div class="modal fade" id="viewCardModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">View Card</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p><strong>Name:</strong> <span id="viewName"></span></p>
                            <p><strong>User ID:</strong> <span id="viewUserId"></span></p>
                            <p><strong>Account Number:</strong> <span id="viewAccountNumber"></span></p>
                            <p><strong>Card Number:</strong> <span id="viewCardNumber"></span></p>
                            <p><strong>Expiry Date:</strong> <span id="viewExpiryDate"></span></p>
                            <p><strong>Card Limit:</strong> <span id="viewCardLimit"></span></p>
                            <p><strong>Assigned Date:</strong> <span id="viewAssignedDate"></span></p>
                            <p><strong>Created Date:</strong> <span id="viewCreatedDate"></span></p>
                            <p><strong>Status:</strong> <span id="viewStatus"></span></p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card Status Update Modal -->
            <div class="modal fade" id="cardStatusUpdateModal" tabindex="-1"
                aria-labelledby="cardStatusUpdateModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="cardStatusUpdateModalLabel">Update Card Status</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label for="cardStatusSelect">Status</label>
                                <select class="form-select" id="cardStatusSelect">
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                    <option value="Blocked">Blocked</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary"
                                onclick="confirmCardStatusUpdate()">Update</button>
                        </div>
                    </div>
                </div>
            </div>