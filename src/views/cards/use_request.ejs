<%- contentFor('title') %>Card Transactions - Vertex Admin

<%- contentFor('style') %>
<style>
    .main-content {
        padding: 20px;
    }
    
    .welcome-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .table-section {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .date-filter {
        max-width: 150px;
    }
    
    .status-badge {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
    }
    
    .status-active {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-inactive {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .action-btn {
        padding: 5px 10px;
        font-size: 14px;
        margin: 0 2px;
    }
</style>

<%- contentFor('body') %>
<div class="main-content">
    <div class="welcome-section">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="mb-0">Use Request</h2>
        </div>
        <!-- Filters Section -->
        <form id="filterForm" class="row g-3">
            <div class="col-md-4">
                <!-- <label class="form-label">User ID</label> -->
                <input type="text" class="form-control" name="user_id" maxlength="8"
                    value="<%= query.user_id || '' %>" placeholder="Enter User ID">
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Filter</button>
                    <button type="button" class="btn btn-secondary" onclick="resetFilters()">Reset</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Table Section -->
    <div class="table-section">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>S.No.</th>
                        <th>Date</th>
                        <th>User</th>
                        <th>Account Number</th>
                        <th>Request Type</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (transactions && transactions.length > 0) { %>
                        <% transactions.forEach((transaction, index) => { %>
                            <tr>
                                <td><%= (pagination.currentPage - 1) * 10 + index + 1 %></td>
                                <td><%= new Date(transaction.created_date).toLocaleDateString() %></td>
                                <td>
                                    <% if (transaction.user) { %>
                                        <%= transaction.user.name %> (<%= transaction.user.user_id %>)
                                    <% } else { %>
                                        -
                                    <% } %>
                                </td>
                                <td>
                                    <% if (transaction.user && transaction.user.account_number) { %>
                                        <%= transaction.user.account_number %>
                                    <% } else { %>
                                        -
                                    <% } %>
                                </td>
                                <td><%= transaction.payment_category %></td>
                                <td><%= transaction.comment %></td>
                                <td><%= (transaction.amount) ? 'â‚¹' + transaction.amount : '--' %></td>
                                <td>
                                    <% if (transaction.status.toLowerCase() === 'pending') { %>
                                        <span
                                            class="status-badge status-pending"
                                            onclick="updateCardStatus('<%= transaction.id %>', '<%= transaction.status %>')">
                                            <%= transaction.status %>
                                        </span>
                                    <% } else { %>
                                        <span class="status-badge <%= transaction.status.toLowerCase() === 'approved' ? 'status-active' : 'status-inactive' %>">
                                            <%= transaction.status %>
                                        </span>
                                    <% } %>
                                </td>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="8" class="text-center">No requests found</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <nav>
        <ul class="pagination">
            <li class="page-item <%= pagination.currentPage === 1 ? 'disabled' : '' %>">
                <a class="page-link"
                    href="?page=<%= pagination.currentPage - 1 %>&user_id=<%= query.user_id || '' %>"
                    tabindex="-1">Previous</a>
            </li>
            <% for(let i=1; i <=pagination.totalPages; i++) { %>
                <li class="page-item <%= pagination.currentPage === i ? 'active' : '' %>">
                    <a class="page-link"
                        href="?page=<%= i %>&user_id=<%= query.user_id || '' %>">
                        <%= i %>
                    </a>
                </li>
            <% } %>
            <li class="page-item <%= pagination.currentPage === pagination.totalPages ? 'disabled' : '' %>">
                <a class="page-link"
                    href="?page=<%= pagination.currentPage + 1 %>&user_id=<%= query.user_id || '' %>">Next</a>
            </li>
        </ul>
    </nav>
</div>


<!-- Card Status Update Modal -->
<div class="modal fade" id="cardStatusUpdateModal" tabindex="-1"
    aria-labelledby="cardStatusUpdateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cardStatusUpdateModalLabel">Update Card Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="cardStatusSelect">Status</label>
                    <select class="form-select" id="cardStatusSelect">
                        <option value="Approved">Approved</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary"
                    onclick="confirmCardStatusUpdate()">Update</button>
            </div>
        </div>
    </div>
</div>

<script>
function resetFilters() {
    // Clear all form fields
    document.querySelector('input[name="user_id"]').value = '';
    // Submit the form with cleared values
    window.location.href = '/cards/use-request';
}

let currentCardId = null;
function updateCardStatus(id, currentStatus) {
    currentCardId = id;
    const statusSelect = document.getElementById('cardStatusSelect');
    statusSelect.value = currentStatus;
    const modal = new bootstrap.Modal(document.getElementById('cardStatusUpdateModal'));
    modal.show();
}

async function confirmCardStatusUpdate() {
    const newStatus = document.getElementById('cardStatusSelect').value;

    try {
        const response = await fetch(`/cards/${currentCardId}/use-request-update`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        });

        if (response.ok) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('cardStatusUpdateModal'));
            modal.hide();
            location.reload();
        } else {
            const data = await response.json();
            alert(data.message || 'Failed to update status');
        }
    } catch (error) {
        console.error('Error updating status:', error);
        alert('Failed to update status');
    }
}
</script>