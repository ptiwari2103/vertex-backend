<%- include('../partials/header') %>
<%- include('../partials/sidebar') %>

<div class="content">
    <div class="container-fluid">
        <div class="row mb-3">
            <div class="col">
                <h2>Pin Management</h2>
            </div>
            <div class="col text-end">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPinModal">
                    <i class="bx bx-plus"></i> Create Pins
                </button>
                <button type="button" class="btn btn-success" id="assignPinBtn" disabled>
                    <i class="bx bx-user-plus"></i> Assign Selected
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-3">
            <div class="card-body">
                <form id="filterForm" method="GET">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label class="form-label">Assigned To</label>
                            <select name="assigned_to" class="form-select">
                                <option value="">All</option>
                                <% users.forEach(user => { %>
                                    <option value="<%= user.id %>" <%= filters.assigned_to == user.id ? 'selected' : '' %>>
                                        <%= user.name %> (<%= user.user_type %>)
                                    </option>
                                <% }); %>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Used By</label>
                            <select name="used_by" class="form-select">
                                <option value="">All</option>
                                <% users.forEach(user => { %>
                                    <option value="<%= user.id %>" <%= filters.used_by == user.id ? 'selected' : '' %>>
                                        <%= user.name %> (<%= user.user_type %>)
                                    </option>
                                <% }); %>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Created Date</label>
                            <input type="date" name="created_date" class="form-control" value="<%= filters.created_date || '' %>">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Assigned Date</label>
                            <input type="date" name="assigned_date" class="form-control" value="<%= filters.assigned_date || '' %>">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Used Date</label>
                            <input type="date" name="used_date" class="form-control" value="<%= filters.used_date || '' %>">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">Filter</button>
                            <a href="/pin-management" class="btn btn-secondary">Reset</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Pins Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" class="form-check-input" id="selectAll">
                                </th>
                                <th>Pin</th>
                                <th>Assigned To</th>
                                <th>Used By</th>
                                <th>Created Date</th>
                                <th>Assigned Date</th>
                                <th>Used Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% pins.forEach(pin => { %>
                                <tr>
                                    <td>
                                        <% if (pin.status === 'available') { %>
                                            <input type="checkbox" class="form-check-input pin-checkbox" value="<%= pin.id %>">
                                        <% } %>
                                    </td>
                                    <td><%= pin.pin %></td>
                                    <td>
                                        <% if (pin.assignedUser) { %>
                                            <%= pin.assignedUser.name %> (<%= pin.assignedUser.user_type %>)
                                        <% } else { %>
                                            -
                                        <% } %>
                                    </td>
                                    <td>
                                        <% if (pin.usedUser) { %>
                                            <%= pin.usedUser.name %> (<%= pin.usedUser.user_type %>)
                                        <% } else { %>
                                            -
                                        <% } %>
                                    </td>
                                    <td><%= new Date(pin.created_date).toLocaleDateString() %></td>
                                    <td><%= pin.assigned_date ? new Date(pin.assigned_date).toLocaleDateString() : '-' %></td>
                                    <td><%= pin.used_date ? new Date(pin.used_date).toLocaleDateString() : '-' %></td>
                                    <td>
                                        <% if (pin.status === 'available') { %>
                                            <span class="badge bg-success">Available</span>
                                        <% } else if (pin.status === 'assigned') { %>
                                            <span class="badge bg-warning">Assigned</span>
                                        <% } else { %>
                                            <span class="badge bg-secondary">Used</span>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <% if (pagination.pageCount > 1) { %>
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-center">
                            <li class="page-item <%= pagination.page === 1 ? 'disabled' : '' %>">
                                <a class="page-link" href="?page=<%= pagination.page - 1 %>" tabindex="-1">Previous</a>
                            </li>
                            <% for(let i = 1; i <= pagination.pageCount; i++) { %>
                                <li class="page-item <%= pagination.page === i ? 'active' : '' %>">
                                    <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                                </li>
                            <% } %>
                            <li class="page-item <%= pagination.page === pagination.pageCount ? 'disabled' : '' %>">
                                <a class="page-link" href="?page=<%= pagination.page + 1 %>">Next</a>
                            </li>
                        </ul>
                    </nav>
                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- Create Pin Modal -->
<div class="modal fade" id="createPinModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Pins</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createPinForm">
                    <div class="mb-3">
                        <label class="form-label">Assigned To (Optional)</label>
                        <select name="assigned_to" class="form-select">
                            <option value="">None</option>
                            <% users.forEach(user => { %>
                                <option value="<%= user.id %>"><%= user.name %> (<%= user.user_type %>)</option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Number of Pins</label>
                        <select name="count" class="form-select" required>
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createPinBtn">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Pin Modal -->
<div class="modal fade" id="assignPinModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Pins</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignPinForm">
                    <div class="mb-3">
                        <label class="form-label">Assign To</label>
                        <select name="assigned_to" class="form-select" required>
                            <option value="">Select User</option>
                            <% users.forEach(user => { %>
                                <option value="<%= user.id %>"><%= user.name %> (<%= user.user_type %>)</option>
                            <% }); %>
                        </select>
                    </div>
                    <input type="hidden" name="pin_ids" id="selectedPinIds">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="assignPinSubmitBtn">Assign</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle select all checkbox
    const selectAllCheckbox = document.getElementById('selectAll');
    const pinCheckboxes = document.querySelectorAll('.pin-checkbox');
    const assignPinBtn = document.getElementById('assignPinBtn');

    selectAllCheckbox.addEventListener('change', function() {
        pinCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateAssignButton();
    });

    pinCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateAssignButton);
    });

    function updateAssignButton() {
        const selectedCount = document.querySelectorAll('.pin-checkbox:checked').length;
        assignPinBtn.disabled = selectedCount === 0;
    }

    // Handle create pin form submission
    document.getElementById('createPinBtn').addEventListener('click', async function() {
        const form = document.getElementById('createPinForm');
        const formData = new FormData(form);
        
        try {
            const response = await fetch('/pin-management/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(Object.fromEntries(formData)),
            });
            
            const data = await response.json();
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message || 'Failed to create pins');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to create pins');
        }
    });

    // Handle assign pin button click
    assignPinBtn.addEventListener('click', function() {
        const selectedPins = Array.from(document.querySelectorAll('.pin-checkbox:checked')).map(cb => cb.value);
        document.getElementById('selectedPinIds').value = JSON.stringify(selectedPins);
        new bootstrap.Modal(document.getElementById('assignPinModal')).show();
    });

    // Handle assign pin form submission
    document.getElementById('assignPinSubmitBtn').addEventListener('click', async function() {
        const form = document.getElementById('assignPinForm');
        const formData = new FormData(form);
        const pin_ids = JSON.parse(formData.get('pin_ids'));
        
        try {
            const response = await fetch('/pin-management/assign', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    pin_ids,
                    assigned_to: formData.get('assigned_to')
                }),
            });
            
            const data = await response.json();
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message || 'Failed to assign pins');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to assign pins');
        }
    });
});
</script>

<%- include('../partials/footer') %>
